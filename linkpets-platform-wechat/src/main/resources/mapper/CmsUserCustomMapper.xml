<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.linkpets.wechat.dao.CmsUserCustomMapper" >
  <resultMap id="BaseResultMap" type="com.linkpets.core.model.CmsUser" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon May 06 14:21:16 CST 2019.
    -->
    <id column="user_id" property="userId" jdbcType="VARCHAR" />
    <result column="nick_name" property="nickName" jdbcType="VARCHAR" />
    <result column="mobile_phone" property="mobilePhone" jdbcType="VARCHAR" />
    <result column="portrait" property="portrait" jdbcType="VARCHAR" />
    <result column="union_id" property="unionId" jdbcType="VARCHAR" />
    <result column="birthday" property="birthday" jdbcType="DATE" />
    <result column="intro" property="intro" jdbcType="VARCHAR" />
    <result column="is_valid" property="isValid" jdbcType="INTEGER" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon May 06 14:21:16 CST 2019.
    -->
    user_id, nick_name, mobile_phone, portrait, union_id, birthday, intro, is_valid,
    create_date
  </sql>


  <select id="getUserByUnionId" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    from cms_user
    where union_id = #{unionId}
  </select>

  <select id="getMaxUserNo" parameterType="java.lang.String" resultType="java.lang.String">
      SELECT MAX(SUBSTR(user_id,11,6)) FROM cms_user WHERE user_id LIKE "${userIdStart}%" AND SUBSTR(user_id,9,2) = #{year,jdbcType=VARCHAR};
  </select>

  <select id="selectUserList" resultType="java.util.Map">
    SELECT
    t_u.user_id AS userId,
    IFNULL(t_u.nick_name,'') AS nickName,
    IFNULL(t_u.mobile_phone,'') AS mobilePhone,
    IFNULL(t_u.photo_path,'') AS photoPath,
    t_u.chip_count AS chipCount,
    DATE_FORMAT(t_u.create_datetime,'%Y-%m-%d') AS createDate,
    t_u.union_id AS unionId,
    SUM(1) AS petCount
    FROM
    cms_user t_u
    LEFT JOIN user_pet t_p
    ON t_p.user_id = t_u.user_id
    AND t_p.del_flag = '0'
    WHERE 1 = 1
    <if test="search != null and search != ''">
      AND (t_u.nick_name like concat('%',#{search,jdbcType=VARCHAR},'%') OR t_u.mobile_phone like concat('%',#{search,jdbcType=VARCHAR},'%'))
    </if>
    GROUP BY t_u.user_id
    ORDER BY t_u.create_datetime DESC
  </select>

  <select id="getUserInfoByUserId" parameterType="java.util.List" resultType="java.util.Map">
    SELECT
    t_u.user_id AS userId,
    IFNULL(t_u.nick_name,'') AS nickName,
    t_u.chip_count AS chipCount,
    t_p.open_id AS openId
    FROM
    user t_u
    LEFT JOIN user_temp t_p
    ON t_p.user_temp_id = t_u.user_id
    WHERE t_u.user_id IN
    <foreach collection="userIds" index="index" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </select>


</mapper>